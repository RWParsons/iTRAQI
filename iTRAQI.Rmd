---
title: "iTRAQI"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::github_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sp)
library(gstat)
library(tidyverse)
library(sf)
library(rnaturalearth)
library(ggspatial)
library(progress)
```

#### resources used:
* kriging https://rpubs.com/nabilabd/118172
* plots https://r-spatial.github.io/sf/articles/sf5.html
* understanding crs https://www.earthdatascience.org/courses/earth-analytics/spatial-data-r/understand-epsg-wkt-and-other-crs-definition-file-types/
* changing crs https://stackoverflow.com/questions/50372533/changing-crs-of-a-sf-object
* spatial aggregations https://cengel.github.io/R-spatial/spatialops.html

# load inputs
```{r}
df_times <- read.csv("input/QLD_locations_with_RSQ_times_20220210.csv")
coordinates(df_times) <- ~ x + y

qld_bounary <- read_sf("input/qld_state_polygon_shp/QLD_STATE_POLYGON_shp.shp")
world <- ne_countries(scale = "medium", returnclass = "sf")
qld_SAs <- st_read("input/qld_sa_zones/MB_2016_QLD.shp")
# ggplot(data = world) +
#   geom_sf() +
#   geom_sf(data=qld_SAs, aes(fill=SA3_NAME16), col = NA) +
#   coord_sf(xlim = c(100.00, 160.00), ylim = c(-45.00, -10.00), expand = T) + 
#   guides(fill="none")

```

# base map and points
```{r}
ggplot(data = world) +
  geom_sf() +
  geom_sf(data=qld_bounary, color="blue") +
  labs( x = "Longitude", y = "Latitude") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  geom_sf(data=qld_SAs, aes(fill=SA3_NAME16), col = NA) +
  geom_point(data=as.data.frame(df_times), aes(x,y))+ 
  guides(fill="none") +
  coord_sf(xlim = c(100.00, 160.00), ylim = c(-45.00, -10.00), expand = T)

```

# kriging - select variogram model (Gaussian looks best)
```{r}
lzn_vgm <- variogram(acute_time~1, df_times)
lzn_fit <- fit.variogram(lzn_vgm, model=vgm("Gau"))

plot(lzn_vgm, lzn_fit)
# show.vgms()
```

# kriging - create spatial domain to interpolate over
```{r}
aus <- raster::getData('GADM', country = 'AUS', level = 1)
grid <- makegrid(aus[aus$NAME_1 == "Queensland",], cellsize = 0.1)
pnts_sf <- st_as_sf(grid, coords = c('x1', 'x2'), crs = st_crs(qld_bounary))

pnts <- pnts_sf %>% mutate(
  # https://gis.stackexchange.com/a/343479
  intersection = as.integer(st_intersects(geometry, qld_bounary))
) %>%
  filter(!is.na(intersection)) %>%
  st_coordinates() %>% 
  as.data.frame()

# add centroids of all polygons to pnts to ensure there's at least one interpolated value within
centroids <- 
  qld_SAs %>%
  st_centroid() %>%
  st_coordinates() %>%
  na.omit() %>% 
  as.data.frame()

pnts2 <- rbind(pnts, centroids)
coordinates(pnts) <- ~ X + Y
coordinates(pnts2) <- ~ X + Y

```

# kriging - generate interpolations
```{r}
lzn_kriged <- krige(acute_time ~ 1, df_times, pnts2, model=lzn_fit)%>%
  as.data.frame()

krige(acute_time ~ 1, df_times, pnts, model=lzn_fit)%>%
  as.data.frame() %>%
  ggplot(aes(X, Y)) + 
  geom_tile(aes(fill=var1.pred)) + 
  coord_equal()+
  scale_fill_gradient(low = "yellow", high="red")

```

# add interpolation layer to map
```{r}
ggplot(data = world) +
  geom_sf() +
  geom_sf(data=qld_bounary, color="blue") +
  labs( x = "Longitude", y = "Latitude") +
  coord_sf(xlim = c(100.00, 160.00), ylim = c(-45.00, -10.00), expand = T) +
  annotation_scale(location = "bl", width_hint = 0.5) +
  geom_tile(data=lzn_kriged, aes(X, Y, fill=var1.pred)) +
  geom_point(data=as.data.frame(df_times), aes(x,y)) +
  scale_fill_gradient(low = "yellow", high="red")

```

# Join the SA polygons together depending on level (SA1 vs SA2)
```{r}

do_union <- function(x){
  pb$tick()
  st_union(x, is_coverage = TRUE)
}

aggregate_by_SA <- function(qld_sf, SA_number, use_dissolve=FALSE){
  sa_main <- glue::glue('SA{SA_number}_{ifelse(SA_number %in% c(3,4), "CODE", "MAIN")}16')
  message(glue::glue('----- grouping polygons within SA{SA_number} -----'))
  if(use_dissolve){
    return(rmapshaper::ms_dissolve(qld_sf, sa_main))
  }
  
  num_ticks <- length(unique(qld_sf[[sa_main]]))
  pb <<- progress_bar$new(
    format = "[:bar] :current/:total (:percent) elapsed :elapsed eta :eta", 
    total=num_ticks
  )
  
  qld_sf %>%
    # https://gis.stackexchange.com/questions/321281/using-sf-to-combine-polygons-that-share-borders
    group_by(across(all_of(sa_main))) %>%
    summarize(geometry=do_union(geometry))
}

qld_SA2s <- aggregate_by_SA(qld_sf=qld_SAs, SA_number=2, use_dissolve=TRUE)
qld_SA1s <- aggregate_by_SA(qld_sf=qld_SAs, SA_number=1, use_dissolve=TRUE)

ggplot(data = world) +
  geom_sf() +
  geom_sf(data=qld_SA2s, aes(fill=1)) +
  coord_sf(xlim = c(138, 153.00), ylim = c(-30.00, -10.00), expand = T) +
  guides(fill="none") +
  scale_fill_gradient(low = "yellow", high="red")
```

# find out why there is a mix of polygons and multipolygons... 
##### spoiler: multipolygons where there are islands
```{r}
mlt_idx <- c()
for(i in 1:nrow(qld_SA2s)){
  geo <- qld_SA2s$geometry[i]
  cl <- class(geo[[1]])[2]
  if(cl=="MULTIPOLYGON"){
    mlt_idx <- append(mlt_idx, i)
  }
}

ggplot(data = world) +
  geom_sf() +
  geom_sf(data=qld_SA2s[mlt_idx,], aes(fill=1)) +
  geom_sf(data=qld_SA2s[-mlt_idx,], aes(fill=0)) +
  coord_sf(xlim = c(138, 153.00), ylim = c(-30.00, -10.00), expand = T) +
  guides(fill="none") +
  scale_fill_gradient(low = "yellow", high="red")
```

# spatial join from SA2 polygons to interpolated values
```{r}
coordinates(lzn_kriged) <- ~ X + Y
lzn_kriged_sf <- st_as_sf(lzn_kriged)

lzn_kriged_sf <- st_set_crs(lzn_kriged_sf, 4326)
lzn_kriged_sf <- st_transform(lzn_kriged_sf, crs = 4326)

qld_SA2s <- st_transform(qld_SA2s, crs = 4326)
qld_SA2s_with_int_times <- st_join(qld_SA2s, lzn_kriged_sf)
# https://ryanpeek.org/2019-04-29-spatial-joins-in-r/

SA2_agg_times <- 
  qld_SA2s_with_int_times %>%
  na.omit() %>%
  as.data.frame() %>%
  group_by(SA2_MAIN16) %>%
  summarize(mean=mean(var1.pred, na.omit=TRUE))

qld_SA2s_agged_times <- merge(qld_SA2s, SA2_agg_times, all.x=TRUE)

ggplot(data = world) +
  geom_sf() +
  geom_sf(data=qld_SA2s_agged_times, aes(fill=mean), col = NA) +
  coord_sf(xlim = c(138, 153.00), ylim = c(-30.00, -10.00), expand = T) +
  guides(fill="none") +
  scale_fill_gradient(low = "yellow", high="red")

```

# spatial join from SA1 polygons to interpolated values
```{r}
qld_SA1s <- st_transform(qld_SA1s, crs = 4326)
qld_SA1s_with_int_times <- st_join(qld_SA1s, lzn_kriged_sf)
# https://ryanpeek.org/2019-04-29-spatial-joins-in-r/

# qld_SA1s_agged_times <- 
#   qld_SA1s_with_int_times %>% 
#   na.omit() %>%
#   group_by(SA1_MAIN16) %>%
#   mutate(mean=mean(var1.pred, na.omit=TRUE)) %>% 
#   ungroup()

SA1_agg_times <- 
  qld_SA1s_with_int_times %>%
  na.omit() %>%
  as.data.frame() %>%
  group_by(SA1_MAIN16) %>%
  summarize(mean=mean(var1.pred, na.omit=TRUE))

qld_SA1s_agged_times <- merge(qld_SA1s, SA1_agg_times, all.x=TRUE)

ggplot(data = world) +
  geom_sf() +
  geom_sf(data=qld_SA1s_agged_times, aes(fill=mean), col = NA) +
  coord_sf(xlim = c(138, 153.00), ylim = c(-30.00, -10.00), expand = T) +
  guides(fill="none") +
  scale_fill_gradient(low = "yellow", high="red")

```

# write interpolation layers to disk
```{r}
saveRDS(qld_SA1s_agged_times, "input/layers/SA1s_acute.rds")
saveRDS(qld_SA2s_agged_times, "input/layers/SA2s_acute.rds")
```

# test space for leaflet
```{r}
library(leaflet)
bins <- c(0, 30, 60, 120, 180, 240, 300, 360, Inf)
pal <- colorBin("YlOrRd", domain = qld_SA2s_agged_times$mean, bins = bins)

leaflet() %>% 
  addMapPane(name = "polygons", zIndex = 410) %>% 
  addMapPane(name = "maplabels", zIndex = 420) %>%
  addProviderTiles("CartoDB.VoyagerNoLabels") %>%
  addProviderTiles("CartoDB.VoyagerOnlyLabels",
                   options = leafletOptions(pane = "maplabels"),
                   group = "map labels") %>%
  addPolygons(
    data=qld_SA2s_agged_times, 
    fillColor = ~pal(mean), 
    color="black", 
    fillOpacity=1,
    weight=1,
    group="polys",
    options = leafletOptions(pane = "polygons")
  )%>%
  addLayersControl(
    baseGroups = "CartoDB.PositronNoLabels",
    overlayGroups = c("map labels","polys")
  )

```


```{r}



```